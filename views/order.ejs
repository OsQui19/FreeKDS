<% title = 'Place Order'; %>
<% bodyClass = 'menu-layout-' + (settings.menu_layout === 'list' ? 'list' : 'grid'); %>
<%- contentFor('head') %>
<link rel="stylesheet" href="/bootstrap-vars.css">
<link rel="stylesheet" href="/order.css">
<link rel="stylesheet" href="/public/css/personalize.css<%= typeof cacheBust !== 'undefined' ? ('?v=' + cacheBust) : '' %>">
<%- contentFor('body') %>
<header class="menu-header">
  <div class="d-flex flex-column">
    <% if (settings.brand_logo) { %>
      <img src="<%= settings.brand_logo %>" alt="<%= settings.brand_name || 'Logo' %>" class="brand-logo">
    <% } else { %>
      <span class="brand-name fw-bold"><%= settings.brand_name || '' %></span>
    <% } %>
    <h1 class="menu-title m-0">Menu</h1>
  </div>
  <div class="header-controls">
    <div class="mt-1 order-type-select">
      <label for="orderType" class="fw-bold me-2">Order Type:</label>
      <select id="orderType" class="form-select d-inline-block w-auto">
        <option value="DINE-IN">DINE-IN</option>
        <option value="TO-GO">TO-GO</option>
        <option value="CATERING">CATERING</option>
      </select>
    </div>
    <% if (typeof hasAccess === 'function' && hasAccess('order')) { %>
      <div class="view-toggle d-flex gap-2">
        <a href="/order" class="btn btn-secondary btn-sm active" aria-current="page" aria-label="Customer View">Customer</a>
        <a href="/foh/order" class="btn btn-secondary btn-sm" aria-label="FOH View">FOH</a>
      </div>
    <% } %>
  </div>
  <nav id="categoryNav">
    <% categories.forEach(cat => { %>
      <a href="#cat-<%= cat.id %>"><%= cat.name %></a>
    <% }) %>
  </nav>
</header>
<main id="menu" class="menu-content container py-3">
  <% categories.forEach(cat => { %>
    <div class="category" id="cat-<%= cat.id %>">
      <h2><%= cat.name %></h2>
      <div class="item-grid">
      <% cat.items.forEach(item => { %>
        <div class="item-card">
          <img src="<%= item.image_url || '/no-image-150.png' %>" alt="<%= item.name %>">
          <span class="item-name"><%= item.name %></span>
          <span class="item-price">$<%= Number(item.price).toFixed(2) %></span>
          <button class="btn btn-primary" data-id="<%= item.id %>"><i class="bi bi-plus-lg"></i></button>
        </div>
      <% }) %>
      </div>
    </div>
  <% }) %>
</main>
<div class="cart" id="cart">
  <h3>Your Order</h3>
  <ul id="cartItems"></ul>
  <div id="cartTotal" class="cart-total">$0.00</div>
  <button id="submitBtn" class="btn btn-success" disabled>Submit Order</button>
</div>
<div id="modModal" class="modal" tabindex="-1" aria-labelledby="modTitle">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modal-small bg-white text-dark">
      <div class="modal-header">
        <h5 class="modal-title" id="modTitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-3">
        <div id="modOptions"></div>
        <div class="mb-2">
          <label for="modInstructions" class="form-label">Special Instructions:</label>
          <textarea id="modInstructions" rows="2" class="form-control"></textarea>
        </div>
        <div class="mb-2 form-check">
          <input type="checkbox" id="modAllergy" class="form-check-input">
          <label for="modAllergy" class="form-check-label">Allergy</label>
        </div>
        <div class="mb-2 d-none" id="modAllergyDetailDiv">
          <label for="modAllergyDetail" class="form-label">Allergy Details:</label>
          <input type="text" id="modAllergyDetail" class="form-control" placeholder="e.g. peanuts, dairy">
        </div>
      </div>
      <div class="modal-footer">
        <button id="modConfirm" class="btn btn-success">Add Item</button>
        <button id="modCancel" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>
</div>
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="orderToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-body" id="orderToastBody"></div>
  </div>
</div>
<% if (user && user.role === 'management') { %>
  <button id="personalizeToggle" class="btn btn-primary" type="button" aria-controls="personalizePanel" aria-expanded="false">
    Personalize
  </button>
  <aside id="personalizePanel" class="personalize-panel" aria-hidden="true">
    <header class="personalize-header">
      <h2 class="h6 m-0">Personalize Display</h2>
      <button type="button" class="btn btn-sm btn-outline-secondary" id="personalizeClose" aria-label="Close">âœ•</button>
    </header>
    <div class="personalize-body">
      <label class="form-label">Density</label>
      <select id="uiDensity" class="form-select">
        <option value="comfortable">Comfortable</option>
        <option value="compact">Compact</option>
      </select>
      <label class="form-label mt-3">Font size</label>
      <select id="uiFontSize" class="form-select">
        <option value="base">Base</option>
        <option value="lg">Large</option>
        <option value="xl">XL</option>
      </select>
      <div class="form-check mt-3">
        <input class="form-check-input" type="checkbox" id="showTimers" checked>
        <label class="form-check-label" for="showTimers">Show ticket timers</label>
      </div>
      <div class="form-check mt-2">
        <input class="form-check-input" type="checkbox" id="soundAlerts" checked>
        <label class="form-check-label" for="soundAlerts">Enable sound alerts</label>
      </div>
    </div>
    <div class="personalize-actions">
      <button class="btn btn-secondary" id="personalizeReset" type="button">Reset</button>
      <button class="btn btn-primary" id="personalizeSave" type="button">Save</button>
    </div>
  </aside>
<% } %>
<script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script defer src="/order.js" data-table="<%= table %>" data-categories='<%- JSON.stringify(categories) %>' data-mod-groups='<%- JSON.stringify(modGroups || []) %>'></script>
