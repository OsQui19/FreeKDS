<div class="container admin-container inventory-tabs">
  <h1 class="admin-section-title">Inventory</h1>
  <ul class="nav nav-tabs" id="inventoryTabs" role="tablist">
    <li class="nav-item"><a href="#" id="itemsTab" class="nav-link active" data-pane="itemsPane" role="tab" aria-controls="itemsPane" aria-selected="true">Items</a></li>
    <li class="nav-item"><a href="#" id="usageLogTab" class="nav-link" data-pane="usageLogPane" role="tab" aria-controls="usageLogPane" aria-selected="false">Usage Log</a></li>
    <li class="nav-item"><a href="#" id="usageSummaryTab" class="nav-link" data-pane="usageSummaryPane" role="tab" aria-controls="usageSummaryPane" aria-selected="false">Usage Summary</a></li>
    <li class="nav-item"><a href="#" id="suppliersTab" class="nav-link" data-pane="suppliersPane" role="tab" aria-controls="suppliersPane" aria-selected="false">Suppliers</a></li>
    <li class="nav-item"><a href="#" id="ordersTab" class="nav-link" data-pane="ordersPane" role="tab" aria-controls="ordersPane" aria-selected="false">Purchase Orders</a></li>
  </ul>
  <div class="tab-content">
    <div class="inventory-pane active" id="itemsPane" role="tabpanel" aria-labelledby="itemsTab">
      <div class="ingredient-list mb-3">
        <div class="d-flex mb-2 align-items-center">
          <select id="filterCategory" class="form-select form-select-sm me-2" style="width:auto;">
            <option value="">All Categories</option>
            <% itemCategories.forEach(cat => { %>
              <option value="<%= cat.id %>"><%= cat.name %></option>
            <% }) %>
          </select>
          <button id="addCategoryBtn" type="button" class="btn btn-primary btn-sm">Add</button>
        </div>
        <div class="mb-3" id="quickAddWrapper">
          <form
            id="quickAddForm"
            action="/admin/inventory/transactions"
            method="POST"
            class="d-flex gap-2"
          >
            <input
              id="quickAddName"
              class="form-control form-control-sm"
              list="inventoryItems"
              placeholder="Inventory item"
              autocomplete="off"
            />
            <input type="hidden" name="ingredient_id" id="quickAddId" />
            <input
              id="quickAddQty"
              class="form-control form-control-sm"
              type="number"
              step="0.01"
              name="quantity"
              placeholder="Quantity"
              style="width:6em;"
            />
            <button
              id="quickAddBtn"
              type="submit"
              class="btn btn-secondary btn-sm"
            >
              Add
            </button>
          </form>
        </div>
        <table class="table table-sm ingredient-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Stock</th>
              <th>Unit</th>
              <th>Category</th>
              <th>SKU</th>
              <th>Cost</th>
              <th>Public</th>
              <th></th>
              <th></th>
            </tr>
          </thead>
          <tbody>
          <% ingredients.forEach(ing => { %>
            <tr data-category="<%= ing.category_id %>">
              <form action="/admin/ingredients" method="POST">
                <input type="hidden" name="id" value="<%= ing.id %>">
                <td><input class="form-control form-control-sm" type="text" name="name" value="<%= ing.name %>" required></td>
                <td><input class="form-control form-control-sm" type="number" step="0.01" name="quantity" value="<%= ing.quantity %>" required></td>
                <td>
                  <select class="form-select form-select-sm" name="unit_id">
                    <option value="">Unit</option>
                    <% units.forEach(u => { %>
                      <option value="<%= u.id %>" <%= ing.unit_id === u.id ? 'selected' : '' %>><%= u.abbreviation %></option>
                    <% }) %>
                  </select>
                </td>
                <td>
                  <select class="form-select form-select-sm" name="category_id">
                    <option value="">No Category</option>
                    <% itemCategories.forEach(c => { %>
                      <option value="<%= c.id %>" <%= ing.category_id === c.id ? 'selected' : '' %>><%= c.name %></option>
                    <% }) %>
                  </select>
                </td>
                <td><input class="form-control form-control-sm" type="text" name="sku" value="<%= ing.sku || '' %>" placeholder="SKU"></td>
                <td><input class="form-control form-control-sm" type="number" step="0.01" name="cost" value="<%= ing.cost %>" placeholder="Cost"></td>
                <td class="text-center">
                  <input class="form-check-input" type="checkbox" name="is_public" value="1" id="pub-<%= ing.id %>" <%= ing.is_public ? 'checked' : '' %>>
                </td>
                <td><button type="submit" class="btn btn-primary btn-sm">Save</button></td>
              </form>
              <td>
                <form action="/admin/ingredients/delete" method="POST" data-confirm="Delete ingredient &quot;<%= ing.name %>&quot;?">
                  <input type="hidden" name="id" value="<%= ing.id %>">
                  <button type="submit" class="btn btn-secondary btn-sm">Delete</button>
                </form>
              </td>
            </tr>
          <% }) %>
          <tr data-category="" class="add-row">
            <td>
              <input class="form-control form-control-sm" form="newIngredientForm" type="text" name="name" placeholder="Name" required>
            </td>
            <td>
              <input class="form-control form-control-sm" form="newIngredientForm" type="number" step="0.01" name="quantity" value="0" placeholder="Stock" required>
            </td>
            <td>
              <select class="form-select form-select-sm" form="newIngredientForm" name="unit_id">
                <option value="">Unit</option>
                <% units.forEach(u => { %>
                  <option value="<%= u.id %>"><%= u.abbreviation %></option>
                <% }) %>
              </select>
            </td>
            <td>
              <select class="form-select form-select-sm" form="newIngredientForm" name="category_id">
                <option value="">No Category</option>
                <% itemCategories.forEach(c => { %>
                  <option value="<%= c.id %>"><%= c.name %></option>
                <% }) %>
              </select>
            </td>
            <td><input class="form-control form-control-sm" form="newIngredientForm" type="text" name="sku" placeholder="SKU"></td>
            <td><input class="form-control form-control-sm" form="newIngredientForm" type="number" step="0.01" name="cost" value="0" placeholder="Cost"></td>
            <td class="text-center">
              <input class="form-check-input" form="newIngredientForm" type="checkbox" name="is_public" value="1" id="new-public">
            </td>
            <td><button form="newIngredientForm" type="submit" class="btn btn-primary btn-sm">Add</button></td>
          </tr>
          </tbody>
        </table>
        <form id="newIngredientForm" action="/admin/ingredients" method="POST" class="d-none"></form>
      </div>

      <div id="addCategoryModal" class="modal d-none">
        <div class="modal-content modal-small">
          <button id="addCategoryCancel" class="btn-secondary btn-sm mb-2">Close</button>
          <form id="addCategoryForm" action="/admin/item-categories" method="POST">
            <div class="mb-2">
              <label class="form-label">Category Name</label>
              <input type="text" name="name" class="form-control form-control-sm" required>
            </div>
            <div class="mb-2">
              <label class="form-label">Parent Category</label>
              <select name="parent_id" class="form-select form-select-sm">
                <option value="">None</option>
                <% itemCategories.forEach(c => { %>
                  <option value="<%= c.id %>"><%= c.name %></option>
                <% }) %>
              </select>
            </div>
            <button type="submit" class="btn btn-primary btn-sm">Add</button>
          </form>
        </div>
      </div>
    </div>

    <div class="inventory-pane" id="usageLogPane" role="tabpanel" aria-labelledby="usageLogTab">
      <h2>Recent Usage</h2>
      <form id="logRangeForm" class="row g-2 mb-2">
        <div class="col-auto">
          <input type="date" name="start" class="form-control form-control-sm" required>
        </div>
        <div class="col-auto">
          <input type="date" name="end" class="form-control form-control-sm" required>
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-sm btn-primary">Load</button>
        </div>
      </form>
      <table class="table">
        <thead>
          <tr><th>Time</th><th>Order</th><th>Item</th><th>Ingredient</th><th>Amount</th></tr>
        </thead>
        <tbody>
        <% logs.forEach(l => { %>
            <tr>
              <td><%= l.created_at.toLocaleString ? l.created_at.toLocaleString() : l.created_at %></td>
              <td><%= l.order_id %></td>
              <td><%= l.item_name %></td>
              <td><%= l.ingredient_name %></td>
              <td><%= l.amount %> <%= l.unit || '' %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <div class="inventory-pane" id="usageSummaryPane" role="tabpanel" aria-labelledby="usageSummaryTab">
      <h2>Usage Summary</h2>
      <table class="table">
        <thead>
          <tr><th>Ingredient</th><th>Total Used</th></tr>
        </thead>
        <tbody>
          <% summary.forEach(s => { %>
            <tr>
              <td><%= s.name %></td>
              <td><%= s.total %> <%= s.unit || '' %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <div class="inventory-pane" id="suppliersPane" role="tabpanel" aria-labelledby="suppliersTab">
      <div class="container admin-container">
        <h1>Suppliers</h1>
        <table class="table">
          <thead>
            <tr><th>Name</th><th>Contact</th><th></th><th></th></tr>
          </thead>
          <tbody>
            <% suppliers.forEach(s => { %>
            <tr>
              <form action="/admin/suppliers" method="POST">
                <td>
                  <input type="hidden" name="id" value="<%= s.id %>">
                  <input class="form-control" type="text" name="name" value="<%= s.name %>" required>
                </td>
                <td><input class="form-control" type="text" name="contact_info" value="<%= s.contact_info || '' %>"></td>
                <td><button class="btn btn-primary btn-sm" type="submit">Save</button></td>
              </form>
              <td>
                <form action="/admin/suppliers/delete" method="POST" onsubmit="return confirm('Delete supplier \"<%= s.name %>\"?');">
                  <input type="hidden" name="id" value="<%= s.id %>">
                  <button class="btn btn-secondary btn-sm" type="submit">Delete</button>
                </form>
              </td>
            </tr>
            <% }) %>
            <tr>
              <form action="/admin/suppliers" method="POST">
                <td><input class="form-control" type="text" name="name" placeholder="Name" required></td>
                <td><input class="form-control" type="text" name="contact_info" placeholder="Contact"></td>
                <td colspan="2"><button class="btn btn-primary btn-sm" type="submit">Add</button></td>
              </form>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="inventory-pane" id="ordersPane" role="tabpanel" aria-labelledby="ordersTab">
      <div class="container admin-container">
        <h1>Purchase Orders</h1>
        <table class="table mb-3">
          <thead>
            <tr><th>Date</th><th>Supplier</th><th>Location</th><th>Status</th><th></th></tr>
          </thead>
          <tbody>
            <% orders.forEach(o => { %>
            <tr>
              <td><a href="/admin/purchase-orders/<%= o.id %>"><%= o.order_date.toISOString ? o.order_date.toISOString().slice(0,10) : o.order_date %></a></td>
              <td><%= o.supplier_name %></td>
              <td><%= o.location_name || '' %></td>
              <td><%= o.status %></td>
              <td>
                <form action="/admin/purchase-orders/delete" method="POST" onsubmit="return confirm('Delete order?');">
                  <input type="hidden" name="id" value="<%= o.id %>">
                  <button class="btn btn-secondary btn-sm" type="submit">Delete</button>
                </form>
              </td>
            </tr>
            <% }) %>
          </tbody>
        </table>
        <h2>New Order</h2>
        <form action="/admin/purchase-orders" method="POST" class="row g-2">
          <div class="col-auto">
            <input class="form-control" type="date" name="order_date" required>
          </div>
          <div class="col-auto">
            <select class="form-select" name="supplier_id" required>
              <option value="">Supplier</option>
              <% suppliers.forEach(s => { %>
              <option value="<%= s.id %>"><%= s.name %></option>
              <% }) %>
            </select>
          </div>
          <div class="col-auto">
            <select class="form-select" name="location_id">
              <option value="">Location</option>
              <% locations.forEach(l => { %>
              <option value="<%= l.id %>"><%= l.name %></option>
              <% }) %>
            </select>
          </div>
          <div class="col-auto">
            <button class="btn btn-primary" type="submit">Create</button>
          </div>
        </form>
      </div>
    </div>


  </div>
</div>
<datalist id="inventoryItems">
  <% ingredients.forEach(ing => { %>
    <option value="<%= ing.name %>" data-id="<%= ing.id %>"></option>
  <% }) %>
</datalist>
<script type="module" defer src="/adminInventory.js" data-ingredients='<%= JSON.stringify(ingredients) %>'></script>
<script defer src="/inventoryTabs.js"></script>
