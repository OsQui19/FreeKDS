<div class="container admin-container inventory-tabs">
  <h1>Inventory</h1>
  <ul class="nav nav-tabs" id="inventoryTabs">
    <li class="nav-item"><a href="#" class="nav-link active" data-pane="itemsPane">Items</a></li>
    <li class="nav-item"><a href="#" class="nav-link" data-pane="usageLogPane">Usage Log</a></li>
    <li class="nav-item"><a href="#" class="nav-link" data-pane="usageSummaryPane">Usage Summary</a></li>
  </ul>
  <div class="tab-content">
    <div class="inventory-pane active" id="itemsPane">
      <div class="ingredient-list mb-3">
        <div class="d-flex mb-2">
          <select id="filterCategory" class="form-select form-select-sm me-2" style="width:auto;">
            <option value="">All Categories</option>
            <% itemCategories.forEach(cat => { %>
              <option value="<%= cat.id %>"><%= cat.name %></option>
            <% }) %>
          </select>
        </div>
        <div class="mb-3" id="quickAddWrapper">
          <form
            id="quickAddForm"
            action="/admin/inventory/transactions"
            method="POST"
            class="d-flex gap-2"
          >
            <input
              id="quickAddName"
              class="form-control form-control-sm"
              list="inventoryItems"
              placeholder="Inventory item"
              autocomplete="off"
            />
            <input type="hidden" name="ingredient_id" id="quickAddId" />
            <input
              id="quickAddQty"
              class="form-control form-control-sm"
              type="number"
              step="0.01"
              name="quantity"
              placeholder="Quantity"
              style="width:6em;"
            />
            <button
              id="quickAddBtn"
              type="submit"
              class="btn btn-secondary btn-sm"
            >
              Add
            </button>
          </form>
        </div>
        <table class="table table-sm ingredient-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Stock</th>
              <th>Unit</th>
              <th>Category</th>
              <th>SKU</th>
              <th>Cost</th>
              <th>Public</th>
              <th></th>
              <th></th>
            </tr>
          </thead>
          <tbody>
          <% ingredients.forEach(ing => { %>
            <tr data-category="<%= ing.category_id %>">
              <form action="/admin/ingredients" method="POST">
                <input type="hidden" name="id" value="<%= ing.id %>">
                <td><input class="form-control form-control-sm" type="text" name="name" value="<%= ing.name %>" required></td>
                <td><input class="form-control form-control-sm" type="number" step="0.01" name="quantity" value="<%= ing.quantity %>" required></td>
                <td>
                  <select class="form-select form-select-sm" name="unit_id">
                    <option value="">Unit</option>
                    <% units.forEach(u => { %>
                      <option value="<%= u.id %>" <%= ing.unit_id === u.id ? 'selected' : '' %>><%= u.abbreviation %></option>
                    <% }) %>
                  </select>
                </td>
                <td>
                  <select class="form-select form-select-sm" name="category_id">
                    <option value="">No Category</option>
                    <% itemCategories.forEach(c => { %>
                      <option value="<%= c.id %>" <%= ing.category_id === c.id ? 'selected' : '' %>><%= c.name %></option>
                    <% }) %>
                  </select>
                </td>
                <td><input class="form-control form-control-sm" type="text" name="sku" value="<%= ing.sku || '' %>" placeholder="SKU"></td>
                <td><input class="form-control form-control-sm" type="number" step="0.01" name="cost" value="<%= ing.cost %>" placeholder="Cost"></td>
                <td class="text-center">
                  <input class="form-check-input" type="checkbox" name="is_public" value="1" id="pub-<%= ing.id %>" <%= ing.is_public ? 'checked' : '' %>>
                </td>
                <td><button type="submit" class="btn btn-primary btn-sm">Save</button></td>
              </form>
              <td>
                <form action="/admin/ingredients/delete" method="POST" onsubmit="return confirm('Delete ingredient \"<%= ing.name %>\"?');">
                  <input type="hidden" name="id" value="<%= ing.id %>">
                  <button type="submit" class="btn btn-secondary btn-sm">Delete</button>
                </form>
              </td>
            </tr>
          <% }) %>
          <tr data-category="" class="add-row">
            <td>
              <input class="form-control form-control-sm" form="newIngredientForm" type="text" name="name" placeholder="Name" required>
            </td>
            <td>
              <input class="form-control form-control-sm" form="newIngredientForm" type="number" step="0.01" name="quantity" value="0" placeholder="Stock" required>
            </td>
            <td>
              <select class="form-select form-select-sm" form="newIngredientForm" name="unit_id">
                <option value="">Unit</option>
                <% units.forEach(u => { %>
                  <option value="<%= u.id %>"><%= u.abbreviation %></option>
                <% }) %>
              </select>
            </td>
            <td>
              <select class="form-select form-select-sm" form="newIngredientForm" name="category_id">
                <option value="">No Category</option>
                <% itemCategories.forEach(c => { %>
                  <option value="<%= c.id %>"><%= c.name %></option>
                <% }) %>
              </select>
            </td>
            <td><input class="form-control form-control-sm" form="newIngredientForm" type="text" name="sku" placeholder="SKU"></td>
            <td><input class="form-control form-control-sm" form="newIngredientForm" type="number" step="0.01" name="cost" value="0" placeholder="Cost"></td>
            <td class="text-center">
              <input class="form-check-input" form="newIngredientForm" type="checkbox" name="is_public" value="1" id="new-public">
            </td>
            <td><button form="newIngredientForm" type="submit" class="btn btn-primary btn-sm">Add</button></td>
          </tr>
          </tbody>
        </table>
        <form id="newIngredientForm" action="/admin/ingredients" method="POST" class="d-none"></form>
      </div>
      <h3>Item Categories</h3>
      <button
        class="btn btn-secondary mb-2"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#categorySection"
      >
        Show Categories
      </button>
      <div id="categorySection" class="card collapse mb-4">
        <div class="card-body">
          <div class="category-list">
            <% itemCategories.forEach(cat => { %>
              <div class="mod-row mb-2">
                <form
                  action="/admin/item-categories"
                  method="POST"
                  class="d-flex gap-2 flex-grow-1"
                >
                  <input type="hidden" name="id" value="<%= cat.id %>" />
                  <input
                    class="form-control"
                    type="text"
                    name="name"
                    value="<%= cat.name %>"
                    required
                  />
                  <select class="form-select" name="parent_id">
                    <option value="">No Parent</option>
                    <% itemCategories.forEach(p => { %>
                      <option
                        value="<%= p.id %>"
                        <%= cat.parent_id === p.id ? 'selected' : '' %>
                      >
                        <%= p.name %>
                      </option>
                    <% }) %>
                  </select>
                  <button type="submit" class="btn btn-primary">Save</button>
                </form>
                <form
                  action="/admin/item-categories/delete"
                  method="POST"
                  onsubmit="return confirm('Delete category \"<%= cat.name %>\"?');"
                >
                  <input type="hidden" name="id" value="<%= cat.id %>" />
                  <button type="submit" class="btn btn-secondary">Delete</button>
                </form>
              </div>
            <% }) %>
            <form action="/admin/item-categories" method="POST" class="mod-row mt-2">
              <input
                class="form-control"
                type="text"
                name="name"
                placeholder="Category name"
                required
              />
              <select class="form-select" name="parent_id">
                <option value="">No Parent</option>
                <% itemCategories.forEach(p => { %>
                  <option value="<%= p.id %>"><%= p.name %></option>
                <% }) %>
              </select>
              <button type="submit" class="btn btn-primary">Add Category</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="inventory-pane" id="usageLogPane">
      <h2>Recent Usage</h2>
      <form id="logRangeForm" class="row g-2 mb-2">
        <div class="col-auto">
          <input type="date" name="start" class="form-control form-control-sm" required>
        </div>
        <div class="col-auto">
          <input type="date" name="end" class="form-control form-control-sm" required>
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-sm btn-primary">Load</button>
        </div>
      </form>
      <table class="table">
        <thead>
          <tr><th>Time</th><th>Order</th><th>Item</th><th>Ingredient</th><th>Amount</th></tr>
        </thead>
        <tbody>
        <% logs.forEach(l => { %>
            <tr>
              <td><%= l.created_at.toLocaleString ? l.created_at.toLocaleString() : l.created_at %></td>
              <td><%= l.order_id %></td>
              <td><%= l.item_name %></td>
              <td><%= l.ingredient_name %></td>
              <td><%= l.amount %> <%= l.unit || '' %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <div class="inventory-pane" id="usageSummaryPane">
      <h2>Usage Summary</h2>
      <table class="table">
        <thead>
          <tr><th>Ingredient</th><th>Total Used</th></tr>
        </thead>
        <tbody>
          <% summary.forEach(s => { %>
            <tr>
              <td><%= s.name %></td>
              <td><%= s.total %> <%= s.unit || '' %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>


  </div>
</div>
<datalist id="inventoryItems">
  <% ingredients.forEach(ing => { %>
    <option value="<%= ing.name %>" data-id="<%= ing.id %>"></option>
  <% }) %>
</datalist>
<script>
  window.inventoryIngredients = <%- JSON.stringify(ingredients) %>;
</script>
<script defer src="/adminInventory.js"></script>
<script defer src="/inventoryTabs.js"></script>
